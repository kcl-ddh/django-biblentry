(function(){tinymce.create('tinymce.plugins.BiblEntryPlugin',{init:function(ed,url){var buttons=[{'name':'Author','class_name':'tei-author','unique':0,'color':0x800000},{'name':'Editor','class_name':'tei-editor','unique':0,'color':0xFFA500},{'name':'TitleArticle','class_name':'tei-title teia-level__a','unique':1,'color':0x0000FF},{'name':'TitleMonograph','class_name':'tei-title teia-level__m','unique':1,'color':0x0000FF},{'name':'Date','class_name':'tei-date','unique':1,'color':0x008000},{'name':'Unmark','class_name':'NONE','unique':false},];ed.onInit.add(function(){if(ed.settings.content_css!==false){ed.dom.loadCSS(url+"/css/buttons.css");}});function spanSelection(ed,span_class_name,unique){if(ed.selection.isCollapsed())return;if(unique===null)unique=false;unmarkWithinAndThroughSelection();if(unique)removeAllSpans(ed,span_class_name);var sel_cont=ed.selection.getContent();ed.selection.setContent('<span class="'+span_class_name+'">'+sel_cont+'</span>')}function removeAllSpans(ed,span_class_name){ed.dom.remove(ed.dom.select('span.'+span_class_name),true)}function unmark(span_only){if(span_only===null)span_only=false;for(var node=ed.selection.getNode();node!==null;node=node.parentNode){if(node.attributes&&node.attributes.getNamedItem("class")&&node.attributes.getNamedItem("class").value.match(/^tei-/)){if(span_only&&node.tagName!='SPAN'){break}django.jQuery(node).find('[class|=tei]').each(function(){ed.dom.remove(this,true)});ed.dom.remove(node,true);break}}}function unmarkWithinAndThroughSelection(){var bm=ed.selection.getBookmark();ed.selection.collapse();unmark(true);ed.selection.moveToBookmark(bm);bm=ed.selection.getBookmark();ed.selection.collapse(true);unmark(true);ed.selection.moveToBookmark(bm);bm=ed.selection.getBookmark();var sel_cont=ed.selection.getContent();sel_cont=sel_cont.replace(/<[^>]*>/g,'');ed.selection.setContent(sel_cont);ed.selection.moveToBookmark(bm)}ed.addCommand('mceBiblEntryAuthor',function(){spanSelection(ed,'tei-author')});ed.addCommand('mceBiblEntryEditor',function(){spanSelection(ed,'tei-editor')});ed.addCommand('mceBiblEntryTitleArticle',function(){spanSelection(ed,'tei-title teia-level__a',true)});ed.addCommand('mceBiblEntryTitleMonograph',function(){spanSelection(ed,'tei-title teia-level__m',true)});ed.addCommand('mceBiblEntryDate',function(){spanSelection(ed,'tei-date',true)});ed.addCommand('mceBiblEntryUnmark',function(){unmark(true)});for(i=0;i<buttons.length;i++){var name=buttons[i].name;var namelc=name.toLowerCase();ed.addButton('BiblEntry'+namelc,{title:'biblentry.'+namelc,cmd:'mceBiblEntry'+name,image:url+'/img/'+namelc+'.gif'})}ed.onNodeChange.add(function(ed,cm,n){var inherited_classes='|';for(var node=n;node!==null;node=node.parentNode){inherited_classes+=ed.dom.getAttrib(node,'class')+'|'}var has_selection=!ed.selection.isCollapsed();for(i=0;i<buttons.length;i++){var name=buttons[i].name;var namelc=name.toLowerCase();b=cm.get('BiblEntry'+namelc);if(b){b.setDisabled(!has_selection);b.setState('Selected',inherited_classes.indexOf(buttons[i].class_name)!=-1)}}cm.setDisabled('BiblEntryunmark',!ed.selection.isCollapsed())})},createControl:function(n,cm){return null},getInfo:function(){return{longname:'BiblEntry plugin',author:'Geoffroy Noel',version:'1.0'}}});tinymce.PluginManager.add('biblentry',tinymce.plugins.BiblEntryPlugin)})();